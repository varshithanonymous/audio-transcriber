<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f7f9fc;
            --panel: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --accent: #2563eb;
            --accent2: #10b981;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Inter", "Segoe UI", Arial, sans-serif;
            background: radial-gradient(circle at 10% 20%, rgba(37,99,235,0.08), transparent 24%),
                        radial-gradient(circle at 80% 0%, rgba(16,185,129,0.08), transparent 26%),
                        var(--bg);
            margin: 0; padding: 28px; color: var(--text);
        }
        .wrap { max-width: 1200px; margin: auto; }
        nav a { margin-right: 12px; color: var(--text); text-decoration: none; font-weight: 600; }
        h1 { margin: 0 0 6px; }
        .muted { color: var(--muted); font-size: 13px; }
        .pill { display: inline-block; padding: 6px 10px; background: rgba(37,99,235,0.1); border: 1px solid rgba(37,99,235,0.18); color: var(--text); border-radius: 12px; margin: 3px; font-size: 13px; cursor: pointer; }
        .pill.disabled { opacity: 0.4; pointer-events: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 10px 35px rgba(15,23,42,0.08);
        }
        .xp { font-size: 30px; font-weight: 700; color: var(--accent); }
        .stat { margin-bottom: 8px; }
        .hero {
            display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;
            padding: 14px; border-radius: 14px; margin-bottom: 16px;
            background: linear-gradient(120deg, rgba(37,99,235,0.12), rgba(16,185,129,0.12));
            border: 1px solid var(--border);
        }
        .tag { padding: 6px 10px; border-radius: 999px; background: #eef2ff; font-size: 12px; color: #1f2937; border: 1px solid var(--border); }
        canvas { background: #f8fafc; border-radius: 12px; }
        #congrats { position: fixed; top: 20px; right: 20px; background: #10b981; color: #fff; padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 30px rgba(16,185,129,0.35); display: none; z-index: 50; font-weight: 700; }
    </style>
</head>
<body>
        <div id="congrats">+10 XP ðŸŽ‰ Great job!</div>
        <div class="wrap">
        <nav>
            <a href="/">Home</a>
            <a href="/transcription">Transcription</a>
            <a href="/dataset">Dataset</a>
            <a href="/tutor">Tutor</a>
            <a href="/validation_page">Validation</a>
        </nav>

        <div class="hero">
            <div>
                <h1>Learning Dashboard</h1>
                <div class="muted">XP snapshot, fresh lesson, challenge, and 3 words to learn.</div>
            </div>
            <div class="tag" id="streak">Loadingâ€¦</div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>XP & Level</h3>
                <div id="xpBlock" class="xp">Loadingâ€¦</div>
            </div>
            <div class="card">
                <h3>3 Words to Learn</h3>
                <div id="threeWords" class="muted">Loadingâ€¦</div>
            </div>
            <div class="card">
                <h3>New Lesson</h3>
                <div id="lesson" class="muted">Loadingâ€¦</div>
            </div>
            <div class="card">
                <h3>Daily Challenge</h3>
                <div id="challenge" class="muted">Loadingâ€¦</div>
            </div>
            <div class="card">
                <h3>Stats by Language</h3>
                <div id="stats" class="muted">Loadingâ€¦</div>
            </div>
        </div>

        <h2 style="margin-top:18px;">Analytics</h2>
        <div class="grid">
            <div class="card">
                <h3>XP by Language</h3>
                <canvas id="xpChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3>New Words (last 7 days)</h3>
                <canvas id="wordsChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3>OOV by Language</h3>
                <canvas id="oovChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        async function loadStats() {
            const res = await fetch("/chatbot/stats");
            const data = await res.json();
            const stats = data.stats || {};
            let lines = [];
            let topLang = null;
            Object.keys(stats).forEach(lang => {
                const s = stats[lang];
                lines.push(`<div class="stat"><strong>${lang}</strong>: level ${s.level || s[1] || "beginner"}, XP ${s.total_xp || s.xp || 0}, streak ${s.streak_days || s.streak || 0}d</div>`);
                if (!topLang || (s.total_xp || s.xp || 0) > (stats[topLang].total_xp || stats[topLang].xp || 0)) topLang = lang;
            });
            document.getElementById("stats").innerHTML = lines.join("") || "No stats yet.";
            if (topLang) {
                const top = stats[topLang];
                document.getElementById("xpBlock").innerHTML = `${top.total_xp || top.xp || 0} XP`;
                document.getElementById("streak").innerHTML = `Language: ${topLang} â€¢ Level: ${top.level || "beginner"} â€¢ Streak: ${top.streak_days || top.streak || 0} days`;
            } else {
                document.getElementById("xpBlock").innerHTML = "0 XP";
                document.getElementById("streak").innerHTML = "";
            }
        }

        let learnedWords = new Set(JSON.parse(localStorage.getItem("learned_words") || "[]"));

        async function loadThreeWords() {
            const res = await fetch("/chatbot/new_words?days=7");
            const data = await res.json();
            const words = [];
            Object.values(data.by_date || {}).forEach(list => list.forEach(w => words.push(w)));
            const pick = words.slice(0, 3);
            document.getElementById("threeWords").innerHTML = pick.length
                ? pick.map(w => {
                    const key = `${w.language}:${w.word}`;
                    const disabled = learnedWords.has(key) ? "disabled" : "";
                    return `<span class="pill ${disabled}" data-key="${key}" onclick="markLearned('${w.word}','${w.language}', this)">${w.word} (${w.language})</span>`;
                  }).join("")
                : "No new words yet.";
        }

        async function loadLesson() {
            const res = await fetch("/chatbot/lesson");
            const data = await res.json();
            const lesson = data.lesson || {};
            document.getElementById("lesson").innerHTML = `<div><strong>${lesson.title || "Lesson"}</strong></div><div>${lesson.adaptive_note || lesson.level || ""}</div>`;
        }

        async function loadChallenge() {
            const res = await fetch("/chatbot/daily_challenge");
            const data = await res.json();
            const c = data.challenge || {};
            document.getElementById("challenge").innerHTML = `<div><strong>${c.title || "Challenge"}</strong></div><div>Goal: ${c.target || "-"} | XP: ${c.xp_reward || 0}</div>`;
        }

        function refresh() {
            loadStats();
            loadThreeWords();
            loadLesson();
            loadChallenge();
            loadCharts();
        }

        refresh();
        setInterval(refresh, 10000);

        // Charts
        let xpChart, wordsChart, oovChart;
        function renderChart(ctx, labels, data, title, color) {
            return new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: title, data, backgroundColor: color }] },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        async function loadCharts() {
            const res = await fetch("/chatbot/analytics");
            const data = await res.json();

            const xpLabels = Object.keys(data.xp_by_lang || {});
            const xpData = xpLabels.map(k => data.xp_by_lang[k]);
            if (xpChart) xpChart.destroy();
            xpChart = renderChart(document.getElementById("xpChart"), xpLabels, xpData, "XP", "#0d6efd");

            const wordLabels = Object.keys(data.new_words_by_day || {}).sort();
            const wordData = wordLabels.map(k => data.new_words_by_day[k]);
            if (wordsChart) wordsChart.destroy();
            wordsChart = renderChart(document.getElementById("wordsChart"), wordLabels, wordData, "New Words", "#22c55e");

            const oovLabels = Object.keys(data.oov_by_lang || {});
            const oovData = oovLabels.map(k => data.oov_by_lang[k]);
            if (oovChart) oovChart.destroy();
            oovChart = renderChart(document.getElementById("oovChart"), oovLabels, oovData, "OOV", "#f97316");
        }

        async function markLearned(word, lang, el) {
            const key = `${lang}:${word}`;
            if (learnedWords.has(key)) return;
            await fetch("/chatbot/record_performance", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    user: "default_user",
                    word,
                    lang,
                    lesson_type: "vocabulary",
                    response_time: 0.5,
                    is_correct: true,
                    difficulty_level: "beginner"
                })
            });
            showCongrats();
            learnedWords.add(key);
            localStorage.setItem("learned_words", JSON.stringify([...learnedWords]));
            if (el) el.classList.add("disabled");
            refresh();
        }

        function showCongrats() {
            const c = document.getElementById("congrats");
            c.style.display = "block";
            clearTimeout(window.__cong);
            window.__cong = setTimeout(() => c.style.display = "none", 1800);
        }
    </script>
</body>
</html>

