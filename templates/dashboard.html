{% extends "base.html" %}

{% block title %}Dashboard - LinguaVoice{% endblock %}

{% block content %}
<div style="max-width: 1000px;">
    <div class="flex-between mb-4">
        <div>
            <h1>Dashboard</h1>
            <p style="color: var(--text-muted);">Overview of your learning progress</p>
        </div>
        <a href="/tutor" class="btn btn-primary">Start New Lesson âž”</a>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-4 mb-4">
        <div class="card" style="margin-bottom:0;">
            <div class="stat-label">Total XP</div>
            <div class="stat-value" id="total_xp">0</div>
        </div>
        <div class="card" style="margin-bottom:0;">
            <div class="stat-label">Daily Streak</div>
            <div class="stat-value" id="streak">0</div>
            <div style="font-size:0.8rem; color: var(--text-muted);">days</div>
        </div>
        <div class="card" style="margin-bottom:0;">
            <div class="stat-label">Words Learned</div>
            <div class="stat-value" id="total_words">0</div>
        </div>
        <div class="card" style="margin-bottom:0;">
            <div class="stat-label">Current Level</div>
            <div class="stat-value" id="current_level" style="font-size: 1.5rem;">Beginner</div>
        </div>
    </div>

    <div class="grid grid-cols-2">
        <!-- Daily Challenge -->
        <div class="card">
            <div class="flex-between">
                <h2>ðŸŽ¯ Daily Challenge</h2>
                <span class="badge badge-primary" id="challenge_reward">50 XP</span>
            </div>
            <div id="challenge_content" class="text-center p-4">
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;" id="challenge_title">Loading...
                </div>
                <p id="challenge_desc" style="color: var(--text-muted);">Getting your challenge ready...</p>
                <div style="margin-top: 1rem;">
                    <div
                        style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin: 0 auto; max-width: 200px;">
                        <div id="challenge_progress" style="background: var(--primary); width: 0%; height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Chart -->
        <div class="card">
            <h2>ðŸ“ˆ Activity (New Words)</h2>
            <div style="height: 200px;">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Suggested Words / Quick Actions -->
    <div class="card">
        <h2>ðŸ’¡ Recommended for you</h2>
        <div class="grid grid-cols-3" id="threeWords">
            <!-- Populated by JS -->
            <div style="color: var(--text-muted);">Loading recommendations...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // 1. Load Stats
            const statsRes = await fetch("/chatbot/stats?user=default_user");
            const statsData = await statsRes.json();
            const stats = statsData.stats || {};

            // Aggregate if multiple languages, or pick top. For now simplicity: sum XP
            let totalXP = 0;
            let maxStreak = 0;
            let totalWords = 0;
            let level = 'Beginner';

            // stats is keyed by language code 'en', 'es', etc.
            Object.values(stats).forEach(s => {
                totalXP += (s.total_xp || s.xp || 0);
                if ((s.streak_days || s.streak) > maxStreak) maxStreak = (s.streak_days || s.streak);
                totalWords += (s.vocabulary_size || 0);
                // Simple level logic
                level = s.level || level;
            });

            document.getElementById('total_xp').innerText = totalXP;
            document.getElementById('streak').innerText = maxStreak;
            document.getElementById('total_words').innerText = totalWords;
            document.getElementById('current_level').innerText = level.charAt(0).toUpperCase() + level.slice(1);

            // 2. Load Challenge
            const challengeRes = await fetch("/chatbot/daily_challenge?user=default_user&lang=en"); // Defaulting to EN for dashboard summary
            const challengeData = await challengeRes.json();
            const c = challengeData.challenge;

            if (c) {
                document.getElementById('challenge_title').innerText = c.title || "Daily Goal";
                document.getElementById('challenge_desc').innerText = `Target: ${c.target}`;
                document.getElementById('challenge_reward').innerText = `+${c.xp_reward} XP`;
                // Mock progress for now as API doesn't return current progress on this endpoint
                document.getElementById('challenge_progress').style.width = '30%';
            }

            // 3. Load Chart
            loadCharts();

            // 4. Load Recommendations
            loadRecommendations();

        } catch (e) {
            console.error("Error loading dashboard:", e);
        }
    }

    async function loadCharts() {
        const res = await fetch("/chatbot/analytics?user=default_user");
        const data = await res.json();

        const ctx = document.getElementById('activityChart').getContext('2d');
        const labels = Object.keys(data.new_words_by_day || {}).sort();
        const values = labels.map(k => data.new_words_by_day[k]);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.map(d => d.substring(5)), // MM-DD
                datasets: [{
                    label: 'New Words',
                    data: values,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    async function loadRecommendations() {
        const res = await fetch("/chatbot/new_words?days=7&user=default_user");
        const data = await res.json();
        const container = document.getElementById('threeWords');
        container.innerHTML = '';

        let count = 0;
        // Flatten words
        const all = [];
        Object.values(data.by_date || {}).forEach(list => {
            list.forEach(item => all.push(item));
        });

        // Take last 3
        const recent = all.slice(0, 3);

        if (recent.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">Start a lesson to see words here!</div>';
            return;
        }

        recent.forEach(w => {
            const el = document.createElement('div');
            el.className = 'card';
            el.style.marginBottom = '0';
            el.style.textAlign = 'center';
            el.style.padding = '1rem';
            el.innerHTML = `
                <div style="font-weight: 600; font-size: 1.1rem;">${w.word}</div>
                <div class="badge badge-primary" style="margin-top: 0.5rem; text-transform: uppercase;">${w.language}</div>
            `;
            container.appendChild(el);
        });
    }
</script>
{% endblock %}