{% extends "base.html" %}

{% block title %}Validation - LinguaVoice{% endblock %}

{% block content %}
<div class="flex-between mb-4">
    <div>
        <h1 style="color: #000;">Word Validation History</h1>
        <p style="color: #666;">Real-time log of all words detected and validated.</p>
    </div>
    <div>
        <button class="btn btn-outline"
            style="margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.5rem;"
            onclick="retryValidation()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
            </svg>
            <span>Retry Pending</span>
        </button>
        <a href="/download/validations" class="btn btn-primary" target="_blank"
            style="display: inline-flex; align-items: center; gap: 0.5rem;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" x2="12" y1="15" y2="3"></line>
            </svg>
            <span>Download CSV</span>
        </a>
    </div>
</div>

<!-- Tabs -->
<div style="display: flex; gap: 1rem; border-bottom: 1px solid rgba(74, 144, 226, 0.2); margin-bottom: 1.5rem;">
    <button class="btn btn-outline"
        style="border:none; border-bottom: 2px solid #4A90E2; border-radius: 0; color: #000;" id="tab-valid"
        onclick="switchTab('valid')">Valid Words</button>
    <button class="btn btn-outline"
        style="border:none; border-bottom: 2px solid transparent; border-radius: 0; color: #000;" id="tab-invalid"
        onclick="switchTab('invalid')">Invalid / Pending</button>
</div>

<div class="card">
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 1px solid rgba(74, 144, 226, 0.2);">
                    <th style="padding: 1rem; color: #4A90E2; font-weight: 600;">Time</th>
                    <th style="padding: 1rem; color: #4A90E2; font-weight: 600;">Word</th>
                    <th style="padding: 1rem; color: #4A90E2; font-weight: 600;">Language</th>
                    <th style="padding: 1rem; color: #4A90E2; font-weight: 600;">Meaning / Status</th>
                </tr>
            </thead>
            <tbody id="validation-table">
                <tr>
                    <td colspan="4" style="padding: 2rem; text-align: center; color: #666;">Loading log...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTab = 'valid';
    let allLogs = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadValidations();
        setInterval(loadValidations, 2000); // Poll every 2 seconds
    });

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-valid').style.borderBottomColor = tab === 'valid' ? '#4A90E2' : 'transparent';
        document.getElementById('tab-invalid').style.borderBottomColor = tab === 'invalid' ? '#4A90E2' : 'transparent';
        renderTable();
    }

    async function loadValidations() {
        try {
            const res = await fetch("/api/get_validation_log");
            const data = await res.json();
            allLogs = data;
            renderTable();
        } catch (e) {
            console.error(e);
        }
    }

    async function retryValidation() {
        showToast("Retrying validation for pending words...", "info");
        try {
            const res = await fetch("/api/retry_validation");
            const data = await res.json();
            showToast(data.message || "Retry initiated", "success");
            // Refresh table after short delay
            setTimeout(loadValidations, 3000);
        } catch (e) {
            showToast("Failed to initiate retry", "error");
        }
    }

    function renderTable() {
        const table = document.getElementById("validation-table");

        let filtered = [];
        if (currentTab === 'valid') {
            filtered = allLogs.filter(item => item.status === 'valid');
        } else {
            filtered = allLogs.filter(item => item.status !== 'valid');
        }

        if (filtered.length === 0) {
            table.innerHTML = `<tr><td colspan="4" style="padding: 2rem; text-align: center; color: #666;">No ${currentTab} entries found yet.</td></tr>`;
            return;
        }

        table.innerHTML = filtered.map(item => `
            <tr style="border-bottom: 1px solid rgba(74, 144, 226, 0.2);">
                <td style="padding: 1rem; color: #666; font-size: 0.9rem;">${item.timestamp || '-'}</td>
                <td style="padding: 1rem; font-weight: 600; color: #000;">${item.word}</td>
                <td style="padding: 1rem;"><span class="badge badge-primary">${item.language}</span></td>
                <td style="padding: 1rem; color: #000;">
                    ${item.status === 'valid' ? item.meaning : `<span style="color: #f59e0b;">${item.meaning || item.status}</span>`}
                </td>
            </tr>
        `).join("");
    }
</script>
{% endblock %}