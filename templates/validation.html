{% extends "base.html" %}

{% block title %}Validation - LinguaVoice{% endblock %}

{% block content %}
<div class="flex-between mb-4">
    <div>
        <h1>Word Validation History</h1>
        <p style="color: var(--text-muted);">Real-time log of all words detected and validated.</p>
    </div>
    <div>
        <button class="btn btn-outline" style="margin-right: 0.5rem;" onclick="retryValidation()">ðŸ”„ Retry
            Pending</button>
        <a href="/download/validations" class="btn btn-primary" target="_blank">ðŸ“¥ Download CSV</a>
    </div>
</div>

<!-- Tabs -->
<div style="display: flex; gap: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem;">
    <button class="btn btn-outline" style="border:none; border-bottom: 2px solid var(--primary); border-radius: 0;"
        id="tab-valid" onclick="switchTab('valid')">Valid Words</button>
    <button class="btn btn-outline" style="border:none; border-bottom: 2px solid transparent; border-radius: 0;"
        id="tab-invalid" onclick="switchTab('invalid')">Invalid / Pending</button>
</div>

<div class="card">
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                    <th style="padding: 1rem;">Time</th>
                    <th style="padding: 1rem;">Word</th>
                    <th style="padding: 1rem;">Language</th>
                    <th style="padding: 1rem;">Meaning / Status</th>
                </tr>
            </thead>
            <tbody id="validation-table">
                <tr>
                    <td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">Loading log...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTab = 'valid';
    let allLogs = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadValidations();
        setInterval(loadValidations, 2000); // Poll every 2 seconds
    });

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-valid').style.borderBottomColor = tab === 'valid' ? 'var(--primary)' : 'transparent';
        document.getElementById('tab-invalid').style.borderBottomColor = tab === 'invalid' ? 'var(--danger)' : 'transparent';
        renderTable();
    }

    async function loadValidations() {
        try {
            const res = await fetch("/api/get_validation_log");
            const data = await res.json();
            allLogs = data;
            renderTable();
        } catch (e) {
            console.error(e);
        }
    }

    async function retryValidation() {
        showToast("Retrying validation for pending words...", "info");
        try {
            const res = await fetch("/api/retry_validation");
            const data = await res.json();
            showToast(data.message || "Retry initiated", "success");
            // Refresh table after short delay
            setTimeout(loadValidations, 3000);
        } catch (e) {
            showToast("Failed to initiate retry", "error");
        }
    }

    function renderTable() {
        const table = document.getElementById("validation-table");

        let filtered = [];
        if (currentTab === 'valid') {
            filtered = allLogs.filter(item => item.status === 'valid');
        } else {
            filtered = allLogs.filter(item => item.status !== 'valid');
        }

        if (filtered.length === 0) {
            table.innerHTML = `<tr><td colspan="4" style="padding: 2rem; text-align: center; color: var(--text-muted);">No ${currentTab} entries found yet.</td></tr>`;
            return;
        }

        table.innerHTML = filtered.map(item => `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">${item.timestamp || '-'}</td>
                <td style="padding: 1rem; font-weight: 600;">${item.word}</td>
                <td style="padding: 1rem;"><span class="badge badge-primary">${item.language}</span></td>
                <td style="padding: 1rem;">
                    ${item.status === 'valid' ? item.meaning : `<span style="color: var(--warning);">${item.meaning || item.status}</span>`}
                </td>
            </tr>
        `).join("");
    }
</script>
{% endblock %}