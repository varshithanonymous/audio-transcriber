{% extends "base_sidebar.html" %}

{% block title %}Flashcards - LinguaVoice{% endblock %}
{% block page_title %} {% endblock %}

{% block extra_css %}
<style>
    /* Full Page Game Mode Override from Learning Path */
    .main-content {
        background: #80c056 !important;
        padding: 0 !important;
        overflow-x: hidden;
        position: relative;
    }
    
    .game-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #92d050;
        background-image: 
            radial-gradient(#a3da61 15%, transparent 16%),
            radial-gradient(#80c056 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
        z-index: 0;
        pointer-events: none;
    }
    
    /* Animated Floating Clouds/Particles */
    .bg-shape {
        position: absolute;
        opacity: 0.1;
        border-radius: 50%;
        background: white;
        animation: float-up 20s infinite linear;
    }
    
    @keyframes float-up {
        0% { transform: translateY(100vh) scale(0.8); opacity: 0; }
        20% { opacity: 0.2; }
        80% { opacity: 0.2; }
        100% { transform: translateY(-20vh) scale(1.2); opacity: 0; }
    }

    .flashcard-container {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
        padding-top: 100px;
        min-height: 100vh;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Top HUD */
    .game-hud {
        width: 90%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    
    .hud-pill {
        background: white;
        padding: 8px 20px;
        border-radius: 30px;
        font-weight: 800;
        color: #555;
        box-shadow: 0 4px 0 #ccc;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .progress-track {
        flex: 1;
        height: 12px;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        margin: 0 20px;
        align-self: center;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.5);
    }
    
    .progress-fill {
        height: 100%;
        background: #fbbf24;
        width: 0%;
        transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.3);
    }

    /* 3D Flashcard Stage */
    .scene {
        width: 100%;
        height: 420px;
        perspective: 1000px;
        margin-bottom: 30px;
    }

    .card {
        width: 90%;
        max-width: 380px;
        height: 100%;
        margin: 0 auto;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
    }

    .card.flipped {
        transform: rotateY(180deg);
    }
    
    /* Swipe Animations */
    .card.swipe-left { animation: swipeLeft 0.5s forwards; }
    .card.swipe-right { animation: swipeRight 0.5s forwards; }
    
    @keyframes swipeLeft {
        to { transform: translateX(-120%) rotate(-10deg); opacity: 0; }
    }
    @keyframes swipeRight {
        to { transform: translateX(120%) rotate(10deg); opacity: 0; }
    }
    
    @keyframes appear {
        from { transform: scale(0.8) translateY(50px); opacity: 0; }
        to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .card.entering {
        animation: appear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 25px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        text-align: center;
        background: white;
        border: 5px solid white;
        box-shadow: 
            0 15px 35px rgba(0,0,0,0.2),
            0 5px 0 #e2e8f0;
    }

    .card-front {
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    }

    .card-back {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        transform: rotateY(180deg);
        border-color: #bae6fd;
    }

    .word-text {
        font-size: 3rem;
        font-weight: 900;
        color: #1e293b;
        margin-bottom: 15px;
        text-shadow: 0 2px 0 rgba(0,0,0,0.1);
    }

    .pronounce-text {
        font-size: 1.2rem;
        color: #64748b;
        background: #f1f5f9;
        padding: 5px 15px;
        border-radius: 15px;
        margin-bottom: 25px;
    }

    .btn-sound {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #6366f1;
        color: white;
        border: none;
        box-shadow: 0 4px 0 #4338ca;
        cursor: pointer;
        font-size: 1.2rem;
        transition: transform 0.1s;
    }
    
    .btn-sound:active {
        transform: translateY(3px);
        box-shadow: 0 1px 0 #4338ca;
    }

    .meaning-text {
        font-size: 1.8rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 10px;
    }
    
    .example-text {
        font-style: italic;
        color: #475569;
        font-size: 1.1rem;
        background: rgba(255,255,255,0.5);
        padding: 10px;
        border-radius: 10px;
    }

    .hint-text {
        position: absolute;
        bottom: 20px;
        font-size: 0.8rem;
        color: #94a3b8;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Game Buttons */
    .controls {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .game-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: transform 0.1s;
        font-weight: 800;
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
        gap: 5px;
        position: relative;
    }
    
    .game-btn span { font-size: 1.5rem; }

    .btn-hard {
        background: #ef4444; /* Red */
        box-shadow: 0 6px 0 #b91c1c;
    }
    
    .btn-good {
        background: #f59e0b; /* Orange */
        box-shadow: 0 6px 0 #b45309;
    }
    
    .btn-easy {
        background: #22c55e; /* Green */
        box-shadow: 0 6px 0 #15803d;
    }
    
    .game-btn:active {
        transform: translateY(4px);
        box-shadow: 0 2px 0 rgba(0,0,0,0.5) !important; 
    }
    
    .btn-next {
        background: #3b82f6; /* Blue */
        box-shadow: 0 6px 0 #1d4ed8;
        width: 100px; /* Slightly wider */
    }

    /* Mascot */
    .mascot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 200;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }

    .mascot-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        background: white;
        overflow: hidden;
        cursor: pointer;
    }
    
    .mascot-image img { width: 100%; height: 100%; object-fit: cover; }

    .speech-bubble {
        background: white;
        padding: 10px 15px;
        border-radius: 15px;
        border-bottom-right-radius: 2px;
        margin-bottom: 5px;
        margin-right: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        font-family: 'Comic Sans MS', cursive, sans-serif;
        color: #333;
        font-size: 0.9rem;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
    }

</style>
{% endblock %}

{% block content %}
<div class="game-background" id="bg-anim"></div>

<div class="flashcard-container">
    <!-- HUD -->
    <div class="game-hud">
        <div class="hud-pill">
            <span>üìö</span> <span id="card-counter">1/5</span>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
        <div class="hud-pill">
            <span>üç¨</span> <span id="score-display">0</span>
        </div>
    </div>
    
    <!-- 3D Card Scene -->
    <div class="scene">
        <div class="card entering" id="flashcard" onclick="flipCard()">
            <div class="card-face card-front">
                <div class="word-text" id="card-word">casa</div>
                <div class="pronounce-text" id="card-pronunciation">/Ààka.sa/</div>
                <button class="btn-sound" onclick="event.stopPropagation(); speakWord()">üîä</button>
                <div class="hint-text">Tap to Flip</div>
            </div>
            
            <div class="card-face card-back">
                <div class="meaning-text" id="card-meaning">House</div>
                <div class="example-text" id="card-example">"Mi casa es tu casa"</div>
                <div class="hint-text">Rate to Continue</div>
            </div>
        </div>
    </div>
    
    <!-- Controls -->
        <button class="game-btn btn-hard" onclick="rateCard('hard')">
            <span>ü•µ</span> Hard
        </button>
        <button class="game-btn btn-good" onclick="rateCard('good')">
            <span>ü§î</span> Good
        </button>
        <button class="game-btn btn-easy" onclick="rateCard('easy')">
            <span>üòé</span> Easy
        </button>
        <button class="game-btn btn-next" onclick="nextCard()">
            <span>‚û°Ô∏è</span> Next
        </button>
    </div>
</div>

<!-- Mascot -->
<div class="mascot-container">
    <div class="speech-bubble" id="mascot-speech" style="opacity: 1; transform: translateY(0);">
        Let's learn new words! ü¶Ö
    </div>
    <div class="mascot-image" onclick="speakMascot()">
        <img src="{{ url_for('static', filename='images/serphawk_logo.jpg') }}" alt="Serp Hawk">
    </div>
</div>

<!-- Complete Overlay -->
<div id="complete-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:white; padding:40px; border-radius:30px; text-align:center; animation: pop-in 0.5s;">
        <div style="font-size:4rem;">üéâ</div>
        <h2 style="color:#1e293b; margin:10px 0;">Level Complete!</h2>
        <p style="color:#64748b;">You nailed it!</p>
        <button onclick="startQuiz()" style="background:#22c55e; color:white; border:none; padding:15px 40px; font-size:1.2rem; font-weight:bold; border-radius:15px; margin-top:20px; cursor:pointer; box-shadow:0 5px 0 #15803d;">Start Quiz ‚ñ∂</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sample Data (In real app, this would come from server)
    // Data from server
    const flashcardsData = {{ words | tojson | safe }};
    
    let currentIndex = 0;
    let score = 0;
    let isFlipped = false;
    
    function init() {
        initBackground();
        loadCard(0);
        updateProgress();
    }
    
    function initBackground() {
        const bg = document.querySelector('.game-background');
        for(let i=0; i<15; i++) {
            const div = document.createElement('div');
            div.className = 'bg-shape';
            const size = Math.random() * 60 + 20;
            div.style.width = `${size}px`;
            div.style.height = `${size}px`;
            div.style.left = `${Math.random() * 100}%`;
            div.style.top = `${Math.random() * 100 + 10}vh`;
            div.style.animationDuration = `${Math.random() * 15 + 10}s`;
            div.style.animationDelay = `-${Math.random() * 20}s`;
            bg.appendChild(div);
        }
    }
    
    function loadCard(index) {
        if(index >= flashcardsData.length) {
            document.getElementById('complete-overlay').style.display = 'flex';
            speakMascot("You finished all cards! Awesome!");
            return;
        }
        
        const card = document.getElementById('flashcard');
        const data = flashcardsData[index];
        
        // Reset State
        card.classList.remove('flipped', 'swipe-left', 'swipe-right');
        card.classList.add('entering');
        isFlipped = false;
        
        // Populate Content
        setTimeout(() => {
            document.getElementById('card-word').innerText = data.word;
            document.getElementById('card-pronunciation').innerText = data.pronunciation;
            document.getElementById('card-meaning').innerText = data.meaning;
            document.getElementById('card-example').innerText = data.example;
            
            // Wait for enter animation to finish then remove class
            setTimeout(() => card.classList.remove('entering'), 500);
        }, 100);
        
        updateProgress();
    }
    
    function flipCard() {
        const card = document.getElementById('flashcard');
        card.classList.toggle('flipped');
        isFlipped = !isFlipped;
        
        if(isFlipped) speakMascot("Did you get it right?");
    }
    
    function rateCard(rating) {
        const card = document.getElementById('flashcard');
        if (!isFlipped) {
            speakMascot("Flip the card first! üòâ");
            flipCard();
            return;
        }
        
        // Swipe Animation
        if (rating === 'easy' || rating === 'good') {
            card.classList.add('swipe-right');
            score += 10;
            speakMascot("Nice!");
        } else {
            card.classList.add('swipe-left');
            speakMascot("Don't worry, keep practicing!");
        }
        
        document.getElementById('score-display').innerText = score;
        
        setTimeout(() => {
            currentIndex++;
            loadCard(currentIndex);
        }, 500);
    }
    
    function nextCard() {
        const card = document.getElementById('flashcard');
        if (!isFlipped) {
             speakMascot("Flip to see the meaning!");
             flipCard();
             // Optional to proceed anyway
             // return; 
        }
        
        // Neutral swipe (up or just fade)
        card.classList.add('swipe-right'); // Reuse right swipe for flow
        speakMascot("Moving on...");
        
        setTimeout(() => {
            currentIndex++;
            loadCard(currentIndex);
        }, 500);
    }
    
    function speakWord() {
        const data = flashcardsData[currentIndex];
        const u = new SpeechSynthesisUtterance(data.word);
        u.lang = 'es-ES';
        speechSynthesis.speak(u);
    }
    
    function speakMascot(text) {
        if(text) {
             const bubble = document.getElementById('mascot-speech');
             bubble.innerText = text;
             bubble.style.opacity = 1;
             bubble.style.transform = 'translateY(0)';
             setTimeout(() => {
                 bubble.style.opacity = 0; 
                 bubble.style.transform = 'translateY(10px)';
             }, 3000);
        }
    }
    
    function updateProgress() {
        document.getElementById('card-counter').innerText = `${currentIndex + 1}/${flashcardsData.length}`;
        const pct = ((currentIndex) / flashcardsData.length) * 100;
        document.getElementById('progress-bar').style.width = `${pct}%`;
    }
    
    function startQuiz() {
        window.location.href = `/learning/level/${ {{ level_id }} }/quiz`;
    }
    
    init();

</script>
{% endblock %}
