<!DOCTYPE html>
<html>
<head>
    <title>Adaptive Tutor</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.08);
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #38bdf8;
        }
        body { font-family: "Inter","Segoe UI",Arial,sans-serif; background: var(--bg); margin: 0; padding: 28px; color: var(--text); }
        .wrap { max-width: 1100px; margin: auto; }
        nav a { margin-right: 12px; color: var(--text); text-decoration: none; }
        h1 { margin-bottom: 6px; }
        .muted { color: var(--muted); font-size: 13px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .card { background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: 0 16px 40px rgba(0,0,0,0.35); }
        .pill { display: inline-block; padding: 6px 8px; background: rgba(56,189,248,0.16); color: var(--text); border-radius: 12px; margin: 3px; font-size: 13px; border: 1px solid rgba(56,189,248,0.3); cursor: pointer; }
        .pill.disabled { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body>
    <div class="wrap">
        <nav>
            <a href="/">Home</a>
            <a href="/transcription">Transcription</a>
            <a href="/dataset">Dataset</a>
            <a href="/validation_page">Validation</a>
        </nav>
        <h1>Adaptive Tutor</h1>
        <p class="muted">Tracks vocabulary, OOV words, challenges, and lessons.</p>
        <div class="grid">
            <div class="card">
                <h3>Tutor Controls</h3>
                <button onclick="clearTutorData()" style="background: #dc3545; color: white; padding: 8px 12px; border: none; border-radius: 6px; margin: 4px; cursor: pointer;">üóëÔ∏è Clear All</button>
                <button onclick="clearNewWords()" style="background: #ffc107; color: black; padding: 8px 12px; border: none; border-radius: 6px; margin: 4px; cursor: pointer;">üóëÔ∏è Clear New Words</button>
                <button onclick="clearOOVWords()" style="background: #6f42c1; color: white; padding: 8px 12px; border: none; border-radius: 6px; margin: 4px; cursor: pointer;">üóëÔ∏è Clear OOV</button>
                <button onclick="clearAllAndFresh()" style="background: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 6px; margin: 4px; cursor: pointer;">üîÑ Fresh Start</button>
                <div id="tutorStatus" style="margin: 8px 0; padding: 8px; border-radius: 4px; background: rgba(255,255,255,0.05); font-size: 12px;"></div>
            </div>
            <div class="card">
                <h3>Generated Vocabulary</h3>
                <button onclick="toggleAutoGeneration()" style="background: var(--accent); color: white; padding: 6px 10px; border: none; border-radius: 4px; margin: 4px; cursor: pointer;">üìö Generate New Words</button>
                <a href="/download/vocab_bank" style="background: #28a745; color: white; padding: 6px 10px; text-decoration: none; border-radius: 4px; margin: 4px; display: inline-block;">üìÑ Download Vocab</a>
                <div id="generatedVocab" class="muted">Click generate to see new words based on your vocabulary</div>
            </div>
            <div class="card">
                <h3>New Words (7 days)</h3>
                <div id="newWords" class="muted">Loading‚Ä¶</div>
            </div>
            <div class="card">
                <h3>Out-of-Vocabulary</h3>
                <div id="oovList" class="muted">Loading‚Ä¶</div>
            </div>
            <div class="card">
                <h3>Daily Challenge</h3>
                <div id="challenge" class="muted">Loading‚Ä¶</div>
            </div>
            <div class="card">
                <h3>Learning Stats</h3>
                <div id="stats" class="muted">Loading‚Ä¶</div>
            </div>
        </div>
    </div>

    <script>
        let learnedWords = new Set(JSON.parse(localStorage.getItem("learned_words") || "[]"));

        async function fetchNewWords() {
            const res = await fetch("/chatbot/new_words?days=7");
            const data = await res.json();
            const box = document.getElementById("newWords");
            const entries = [];
            Object.keys(data.by_date || {}).forEach(day => {
                const words = (data.by_date[day] || []).map(w => {
                    const key = `${w.language}:${w.word}`;
                    const disabled = learnedWords.has(key) ? "disabled" : "";
                    return `<span class="pill ${disabled}" data-key="${key}" onclick="markLearned('${w.word}','${w.language}', this)">${w.word} (${w.language})</span>`;
                }).join("");
                entries.push(`<div><strong>${day}</strong>: ${words}</div>`);
            });
            box.innerHTML = entries.join("") || "No new words yet.";
        }

        async function fetchVocab() {
            const res = await fetch("/chatbot/vocabulary?limit=50");
            const data = await res.json();
            const box = document.getElementById("vocabList");
            box.innerHTML = data.items.map(w => {
                const key = `${w.language}:${w.word}`;
                const disabled = learnedWords.has(key) ? "disabled" : "";
                return `<span class="pill ${disabled}" data-key="${key}" onclick="markLearned('${w.word}','${w.language}', this)">${w.word} (${w.language})</span>`;
            }).join("") || "Empty.";
        }

        async function fetchOOV() {
            const res = await fetch("/chatbot/oov");
            const data = await res.json();
            const box = document.getElementById("oovList");
            box.innerHTML = data.items.map(w => `<span class="pill" title="Seen ${w.occurrences}x">${w.word} (${w.language})</span>`).join("") || "None.";
        }

        async function markLearned(word, lang, el) {
            const key = `${lang}:${word}`;
            if (learnedWords.has(key)) return;
            await fetch("/chatbot/record_performance", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    user: "default_user",
                    word,
                    lang,
                    lesson_type: "vocabulary",
                    response_time: 0.5,
                    is_correct: true,
                    difficulty_level: "beginner"
                })
            });
            fetchStats();
            fetchVocab();
            learnedWords.add(key);
            localStorage.setItem("learned_words", JSON.stringify([...learnedWords]));
            if (el) el.classList.add("disabled");
        }

        async function fetchChallenge() {
            const res = await fetch("/chatbot/daily_challenge");
            const data = await res.json();
            const c = data.challenge || {};
            document.getElementById("challenge").innerHTML = `<div><strong>${c.title || "Challenge"}</strong></div><div>Goal: ${c.target || "-"} | XP: ${c.xp_reward || 0}</div>`;
        }

        async function fetchLesson() {
            const res = await fetch("/chatbot/lesson");
            const data = await res.json();
            const lesson = data.lesson || {};
            document.getElementById("lesson").innerHTML = `<div><strong>${lesson.title || "Lesson"}</strong></div><div>${lesson.adaptive_note || lesson.level || ""}</div>`;
        }

        async function fetchStats() {
            const res = await fetch("/chatbot/stats");
            const data = await res.json();
            const stats = data.stats || {};
            const lines = Object.keys(stats).map(lang => {
                const s = stats[lang];
                return `<div><strong>${lang}</strong>: level ${s.level || s[1] || "beginner"}, XP ${s.total_xp || s.xp || 0}, streak ${s.streak_days || s.streak || 0}d</div>`;
            });
            document.getElementById("stats").innerHTML = lines.join("") || "No stats yet.";
        }

        async function generateVocab() {
            document.getElementById('generatedVocab').innerHTML = 'Generating unique words...';
            try {
                const res = await fetch('/api/vocabulary_bank');
                const data = await res.json();
                const box = document.getElementById('generatedVocab');
                if (data.error) {
                    box.innerHTML = `<div style="color: #ef4444;">${data.error}</div>`;
                    return;
                }
                if (data.words && data.words.length === 0) {
                    box.innerHTML = data.message || 'No new words generated';
                    return;
                }
                if (data.words && data.words.length > 0) {
                    let html = '';
                    if (data.words_by_language) {
                        ['en', 'es', 'hi'].forEach(lang => {
                            if (data.words_by_language[lang] && data.words_by_language[lang].length > 0) {
                                            html += '<div style="margin: 8px 0;"><strong>' + lang.toUpperCase() + ':</strong> ';
                                html += data.words_by_language[lang].map(word => 
                                    '<span class="pill" onclick="validateWord(\'' + word + '\', \'' + lang + '\')">' + word + '</span>'
                                ).join('');
                                html += '</div>';
                            }
                        });
                    } else {
                        html = data.words.map(word => '<span class="pill" onclick="validateWord(\'' + word + '\', \'en\')">' + word + '</span>').join('');
                    }
                    html += '<div style="margin-top: 8px; font-size: 11px; color: var(--muted);">' + data.message + '</div>';
                    box.innerHTML = html;
                } else {
                    box.innerHTML = 'No words generated. Try speaking more to build vocabulary.';
                }
            } catch (error) {
                document.getElementById('generatedVocab').innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
            }
        }

        async function validateWord(word, lang = 'en') {
            await fetch(`/validate_word?word=${word}&lang=${lang}`);
            alert(`Word "${word}" (${lang.toUpperCase()}) validated!`);
        }

        function clearTutorData() {
            if (confirm('Clear ALL tutor data?')) {
                fetch('/api/clear_tutor_all', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('tutorStatus').textContent = data.message;
                        refresh();
                    });
            }
        }

        function clearNewWords() {
            if (confirm('Clear new words only?')) {
                fetch('/api/clear_tutor_new_words', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('tutorStatus').textContent = data.message;
                        refresh();
                    });
            }
        }

        function clearOOVWords() {
            if (confirm('Clear OOV words only?')) {
                fetch('/api/clear_tutor_oov', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('tutorStatus').textContent = data.message;
                        refresh();
                    });
            }
        }

        function clearAllAndFresh() {
            if (confirm('COMPLETE FRESH START - Clear everything?')) {
                fetch('/api/clear_all_data', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('tutorStatus').textContent = 'Fresh start complete!';
                        refresh();
                    });
            }
        }

        let autoGenInterval;
        let isAutoGenerating = false;

        async function generateVocab() {
            try {
                const res = await fetch('/api/vocabulary_bank');
                const data = await res.json();
                console.log('Generated:', data.message);
                loadStoredVocab();
            } catch (error) {
                console.error('Generation error:', error);
            }
        }

        function toggleAutoGeneration() {
            const button = document.querySelector('button[onclick="toggleAutoGeneration()"]');
            if (isAutoGenerating) {
                clearInterval(autoGenInterval);
                isAutoGenerating = false;
                button.textContent = 'üìö Generate New Words';
                button.style.background = 'var(--accent)';
            } else {
                isAutoGenerating = true;
                button.textContent = '‚è∏Ô∏è Stop Auto Generation';
                button.style.background = '#dc3545';
                generateVocab();
                autoGenInterval = setInterval(generateVocab, 3000);
            }
        }

        async function loadStoredVocab() {
            try {
                const res = await fetch('/api/get_stored_vocab_bank');
                const data = await res.json();
                const box = document.getElementById('generatedVocab');
                
                if (data.length === 0) {
                    box.innerHTML = 'No vocabulary generated yet. Click generate to start.';
                    return;
                }
                
                // Group by language
                const byLang = {en: [], es: [], hi: []};
                data.forEach(item => {
                    const word = item.word;
                    if (word.match(/[\u0900-\u097F]/)) {
                        byLang.hi.push(word);
                    } else if (word.match(/[√°√©√≠√≥√∫√º√±]/)) {
                        byLang.es.push(word);
                    } else {
                        byLang.en.push(word);
                    }
                });
                
                let html = '<div style="margin-bottom: 8px; font-weight: bold;">All Generated Vocabulary (' + data.length + ' words):</div>';
                ['en', 'es', 'hi'].forEach(lang => {
                    if (byLang[lang].length > 0) {
                        html += '<div style="margin: 8px 0;"><strong>' + lang.toUpperCase() + ' (' + byLang[lang].length + '):</strong><br>';
                        html += byLang[lang].map(word => 
                            '<span class="pill" onclick="validateWord(\'' + word + '\', \'' + lang + '\')" style="margin: 2px; display: inline-block;">' + word + '</span>'
                        ).join('');
                        html += '</div>';
                    }
                });
                
                box.innerHTML = html;
            } catch (error) {
                console.error('Error loading stored vocab:', error);
            }
        }

        function refresh() {
            fetchNewWords();
            fetchOOV();
            fetchChallenge();
            fetchStats();
            loadStoredVocab();
        }

        refresh();
        setInterval(refresh, 10000);
    </script>
</body>
</html>

