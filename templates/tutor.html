{% extends "base.html" %}

{% block title %}AI Tutor - LinguaVoice{% endblock %}

{% block content %}
<div style="height: calc(100vh - 4rem); display: flex; flex-direction: column;">
    <!-- Header / Lesson Context -->
    <div class="flex-between mb-4">
        <div>
            <h1>AI Personal Tutor</h1>
            <p id="lesson-objective" style="color: var(--text-muted);">Loading today's lesson...</p>
        </div>
        <div>
            <span class="badge badge-primary" id="session-words">0 Words Learned Today</span>
        </div>
    </div>

    <!-- Main Workspace -->
    <div style="flex: 1; display: flex; gap: 1.5rem; overflow: hidden;">

        <!-- Left: Chat/Transcript Area -->
        <div class="chat-container" style="flex: 2; height: 100%;">
            <div class="chat-messages" id="chat-box">
                <!-- Welcome Message -->
                <div class="message msg-tutor">
                    Hello! I'm your AI Language Tutor. I'm listening. Speak in <strong>English, Spanish, or
                        Hindi</strong>.
                    <br><br>
                    I will track your vocabulary and help you learn.
                </div>
            </div>

            <div class="chat-controls">
                <button id="mic-btn" class="mic-btn" onclick="toggleRecording()">
                    üé§
                </button>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-left: 1rem;">
                    <span id="status-text">Click to start speaking</span>
                </div>
            </div>
        </div>

        <!-- Right: Lesson/Feedback Board -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto;">

            <!-- Context Card -->
            <div class="card" style="flex-shrink: 0;">
                <h2>üìù Lesson Goals</h2>
                <div id="lesson-content">
                    Loading lesson...
                </div>
            </div>

            <!-- Real-time Feedback Card -->
            <div class="card" style="flex: 1;">
                <h2>üîç Analysis</h2>
                <div id="analysis-content" style="font-size: 0.9rem;">
                    <p style="color: var(--text-muted);">Speak to see analysis here (new words, OOV detections,
                        pronunciation).</p>
                </div>

                <div style="margin-top: 1rem;">
                    <h3>Detected Language</h3>
                    <div id="lang-indicator" class="badge">Waiting...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden audio element if needed for playback -->
<audio id="audio-player" style="display:none;"></audio>
{% endblock %}

{% block scripts %}
<script>
    let isRecording = false;
    let lastTranscriptId = 0;

    document.addEventListener('DOMContentLoaded', () => {
        loadLesson();
        checkRecordingStatus();

        // Poll for transcripts every 2 seconds
        setInterval(fetchTranscripts, 2000);
    });

    async function toggleRecording() {
        const btn = document.getElementById('mic-btn');
        const status = document.getElementById('status-text');

        if (isRecording) {
            // Stop
            await fetch('/record/stop', { method: 'POST' });
            isRecording = false;
            btn.classList.remove('listening');
            status.innerText = "Processing...";
            showToast('Recording stopped. Analyzing...', 'info');
        } else {
            // Start
            await fetch('/record/start', { method: 'POST' });
            isRecording = true;
            btn.classList.add('listening');
            status.innerText = "Listening... Speak now";
            showToast('Microphone active. Listening for EN/ES/HI...', 'success');
        }
    }

    async function checkRecordingStatus() {
        try {
            const res = await fetch('/record/status');
            const data = await res.json();
            if (data.recording) {
                isRecording = true;
                document.getElementById('mic-btn').classList.add('listening');
                document.getElementById('status-text').innerText = "Listening... Speak now";
            }
        } catch (e) { }
    }

    async function loadLesson() {
        try {
            const res = await fetch('/chatbot/lesson?user=default_user');
            const data = await res.json();
            const lesson = data.lesson;

            if (lesson) {
                document.getElementById('lesson-objective').innerText = lesson.title || "Practice Session";
                let html = `<div>${lesson.adaptive_note || ""}</div>`;

                if (lesson.exercises) {
                    html += '<ul style="padding-left: 1.2rem; margin-top: 0.5rem;">';
                    lesson.exercises.forEach(ex => {
                        html += `<li>${ex.instruction || ex.type}</li>`;
                    });
                    html += '</ul>';
                }

                document.getElementById('lesson-content').innerHTML = html;
            }
        } catch (e) {
            console.error("Lesson load failed", e);
        }
    }

    async function fetchTranscripts() {
        try {
            // Using existing /data endpoint
            const res = await fetch('/data?limit=5');
            const data = await res.json();
            // data is list of {timestamp, language, text, audio_file}

            if (!data || data.length === 0) return;

            // Check if we have new items
            // Assuming timestamp helps us sort, but ideally we'd have IDs. 
            // For now, let's just grab the latest and if it's different from what we displayed last...
            // A simple logic: display the latest one if it happened recently (within last 3 secs)
            // Or just render the whole list? No, chat box should append.
            // Let's rely on the first item being the newest.

            const latest = data[0];
            const latestKey = latest.timestamp + latest.text; // rudimentary ID

            if (window._lastDisp !== latestKey) {
                window._lastDisp = latestKey;
                addMessage(latest.text, 'user', latest.language);

                // Trigger analysis update for this new text
                updateAnalysis(latest);
            }

        } catch (e) {
            console.error(e);
        }
    }

    function addMessage(text, type, lang) {
        const box = document.getElementById('chat-box');
        const d = document.createElement('div');
        d.className = `message msg-${type}`;
        d.innerHTML = `
            ${text}
            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                ${lang ? lang.toUpperCase() : ''} ‚Ä¢ Just now
            </div>
        `;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;

        // Simulate Tutor reply occasionally
        if (type === 'user') {
            setTimeout(() => {
                // If it's a known language, give positive feedback
                if (['en', 'es', 'hi'].includes(lang)) {
                    // This is mockup logic for the UI to feel alive. 
                    // Ideally the backend would push this via socket or polling.
                }
            }, 1000);
        }
    }

    async function updateAnalysis(transcript) {
        // Here we could call an endpoint to see analyzed breakdown of the specific text
        // Or just update general stats
        document.getElementById('lang-indicator').innerText = transcript.language ? transcript.language.toUpperCase() : 'Unknown';
        document.getElementById('lang-indicator').className = `badge badge-${transcript.language === 'unknown' ? 'warning' : 'success'}`;

        const res = await fetch('/chatbot/stats?user=default_user');
        const data = await res.json();
        const stats = data.stats || {};

        // Sum total words
        let total = 0;
        Object.values(stats).forEach(s => total += (s.vocabulary_size || 0));
        document.getElementById('session-words').innerText = `${total} Words Learned Total`;
    }
</script>
{% endblock %}